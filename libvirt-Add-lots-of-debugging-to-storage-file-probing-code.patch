From 50a7f26cca61803834819713c40267d4e9801adf Mon Sep 17 00:00:00 2001
Message-Id: <50a7f26cca61803834819713c40267d4e9801adf.1373271637.git.jdenemar@redhat.com>
From: "Daniel P. Berrange" <berrange@redhat.com>
Date: Mon, 25 Feb 2013 16:21:45 -0700
Subject: [PATCH] Add lots of debugging to storage file probing code

https://bugzilla.redhat.com/show_bug.cgi?id=903248

Signed-off-by: Daniel P. Berrange <berrange@redhat.com>
(cherry picked from commit 24643c780bafdc0997cd3de06e75516fd73e7d87)
---
 src/util/storage_file.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/src/util/storage_file.c b/src/util/storage_file.c
index a5402fd..24ef3ea 100644
--- a/src/util/storage_file.c
+++ b/src/util/storage_file.c
@@ -628,6 +628,9 @@ virStorageFileMatchesVersion(int format,
             (buf[fileTypeInfo[format].versionOffset+2] << 8) |
             (buf[fileTypeInfo[format].versionOffset+3]);
     }
+
+    VIR_DEBUG("Compare detected version %d vs expected version %d",
+              version, fileTypeInfo[format].versionNumber);
     if (version != fileTypeInfo[format].versionNumber)
         return false;
 
@@ -650,6 +653,8 @@ virStorageFileGetMetadataFromBuf(int format,
                                  size_t buflen,
                                  virStorageFileMetadata *meta)
 {
+    VIR_DEBUG("path=%s format=%d", path, format);
+
     /* XXX we should consider moving virStorageBackendUpdateVolInfo
      * code into this method, for non-magic files
      */
@@ -785,6 +790,7 @@ virStorageFileProbeFormatFromBuf(const char *path,
     }
 
 cleanup:
+    VIR_DEBUG("format=%d", format);
     return format;
 }
 
@@ -963,6 +969,9 @@ virStorageFileGetMetadataRecurse(const char *path, int format,
                                  bool allow_probe, virHashTablePtr cycle)
 {
     int fd;
+    VIR_DEBUG("path=%s format=%d uid=%d gid=%d probe=%d",
+              path, format, (int)uid, (int)gid, allow_probe);
+
     virStorageFileMetadataPtr ret = NULL;
 
     if (virHashLookup(cycle, path)) {
@@ -1027,6 +1036,9 @@ virStorageFileGetMetadata(const char *path, int format,
                           uid_t uid, gid_t gid,
                           bool allow_probe)
 {
+    VIR_DEBUG("path=%s format=%d uid=%d gid=%d probe=%d",
+              path, format, (int)uid, (int)gid, allow_probe);
+
     virHashTablePtr cycle = virHashCreate(5, NULL);
     virStorageFileMetadataPtr ret;
 
-- 
1.8.2.1

